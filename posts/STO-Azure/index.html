<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Subdomain Takeover in Azure: making a PoC | GoDiego</title><meta name="generator" content="Jekyll v4.0.1" /><meta property="og:title" content="Subdomain Takeover in Azure: making a PoC" /><meta name="author" content="Diego Bernal Adelantado" /><meta property="og:locale" content="en_US" /><meta name="description" content="Most (if not all) bug bounty hunters know what a subdomain takeover is and what its impact is, but do you know how to actually take over the domain and make a working proof of concept?" /><meta property="og:description" content="Most (if not all) bug bounty hunters know what a subdomain takeover is and what its impact is, but do you know how to actually take over the domain and make a working proof of concept?" /><link rel="canonical" href="https://diego95root.github.io/posts/STO-Azure/" /><meta property="og:url" content="https://diego95root.github.io/posts/STO-Azure/" /><meta property="og:site_name" content="GoDiego" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-01T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Subdomain Takeover in Azure: making a PoC" /><meta name="twitter:site" content="@secfaults" /><meta name="twitter:creator" content="@Diego Bernal Adelantado" /> <script type="application/ld+json"> {"description":"Most (if not all) bug bounty hunters know what a subdomain takeover is and what its impact is, but do you know how to actually take over the domain and make a working proof of concept?","@type":"BlogPosting","url":"https://diego95root.github.io/posts/STO-Azure/","headline":"Subdomain Takeover in Azure: making a PoC","dateModified":"2020-11-01T00:00:00+01:00","datePublished":"2020-11-01T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://diego95root.github.io/posts/STO-Azure/"},"author":{"@type":"Person","name":"Diego Bernal Adelantado"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta name="twitter:image" content="/assets/img/favicons/favicon.ico" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><meta name="google-site-verification" content="H84_zouPIHmurw2-AF7oHrWvvqJ1HhxxPpp1B6Vjpx4" /><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async crossorigin="anonymous"></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/favicons/logo.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">GoDiego</a></div><div id="site-subtitle" class="font-italic">Student, Bug Hunter, Security Enthusiast</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/timeline/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>TIMELINE</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT ME</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/diego95root" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/secfaults" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/diego-bernal-adelantado" target="_blank"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.hackthebox.eu/home/users/profile/31531" target="_blank"> <i class="fas fa-cube"></i> </a> <a href=" javascript:window.open('mailto:' + ['diegobernal0905','gmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Subdomain Takeover in Azure: making a PoC</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Subdomain Takeover in Azure: making a PoC</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 1, 2020, 12:00 AM +0100"> Nov 1, 2020 <i class="unloaded">2020-11-01T00:00:00+01:00</i> </span> by <span class="author"> Diego Bernal Adelantado </span></div></div><div class="post-content"> <img src="/assets/posts_details/STO-Azure/images/takeover-main.png"><p>As a bug bounty hunter, one of the vulnerabilities that are learned at the beginning of the road is a subdomain takeover. While the concept of it is simple, just register some domain that hasn’t been claimed but it’s being pointed to, the chances of finding one is nowadays difficult due to the automation some have developed. That’s why most people, even though experienced, have never found one. Up until recently, one of those people was me.</p><p>The basics for me were clear, I registered the dangling domain and then uploaded a proof of concept (PoC). However, in practice, this turned out to be more difficult than expected and I spent quite a bit of time learning how to upload a PoC to a few different Microsoft Azure services. Seeing there wasn’t too much I could find online and the fact that it can be a bit confusing I decided to write this to help others in that position.</p><p>The services I’ll go over were the ones I’ve come across (so far):</p><ul><li>Azure CloudApp: <code class="highlighter-rouge">cloudapp.net</code>.</li><li>Azure Websites: <code class="highlighter-rouge">azurewebsites.net</code>.</li><li>Azure VM: <code class="highlighter-rouge">cloudapp.azure.com</code>.</li><li>Azure TrafficManager: <code class="highlighter-rouge">trafficmanager.net</code> (added on 19/12/2020).</li></ul><h1 id="azure-cloudapp">Azure CloudApp</h1><hr /><p>I’ll start with the one I first came across: Azure CloudApp. The first thing I did was validate with <code class="highlighter-rouge">dig</code> that the subdomain, which I’ve redacted, points to an Azure CloudApp domain. It can be seen from the output that the <code class="highlighter-rouge">CNAME</code> record indeed points to an app that seems to be unclaimed, otherwise the <code class="highlighter-rouge">NXDOMAIN</code> status wouldn’t show up at the top.</p><p><em>Using dig to check DNS resolution</em></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_dig_1.png" alt="Img" /></p><p>Now I want to go to the Azure portal at <a href="https://portal.azure.com/?quickstart=True#create/Microsoft.CloudService">https://portal.azure.com/?quickstart=True#create/Microsoft.CloudService</a> and create a new instance, setting the unclaimed domain as the name of my app.</p><p><em>Azure portal Cloud Service dashboard</em></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_init.png" alt="Img" /></p><p><em>Registering the unclaimed domain</em></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_register.png" alt="Img" /></p><p>Cool! That means that I can take over the domain.</p><h2 id="poc-creation">PoC creation</h2><p>I couldn’t find much online on how to make a working proof of concept even though it is the most important part, as it helps triagers quickly confirm that the submission is valid. Eventually, I found this website, <a href="https://www.c-sharpcorner.com">https://www.c-sharpcorner.com</a>, that had two articles with what I was looking for.</p><ul><li><a href="https://www.c-sharpcorner.com/article/azure-cloud-services-create-hello-world-cloud-service-using-visual-studio/">https://www.c-sharpcorner.com/article/azure-cloud-services-create-hello-world-cloud-service-using-visual-studio/</a> is about how to create a simple service using Visual Studio.</li><li><a href="https://www.c-sharpcorner.com/article/azure-cloud-service-create-package-using-visual-studio/">https://www.c-sharpcorner.com/article/azure-cloud-service-create-package-using-visual-studio/</a> explains how to package the service into the two files required by Azure.</li></ul><p>After following the posts I had my <code class="highlighter-rouge">.cspkg</code> and <code class="highlighter-rouge">.cscfg</code> files to upload. First I created a storage account and then I was able to deploy the app!</p><p><em>Deployment successful</em></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_deploy.png" alt="Img" /></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_running.png" alt="Img" /></p><p>Now that I’ve created the subdomain <code class="highlighter-rouge">dig</code> shows an extra line with the IP of my application and I no longer get <code class="highlighter-rouge">NXDOMAIN</code>, but <code class="highlighter-rouge">NOERROR</code>.</p><p><em>Proving the takeover with dig</em></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_dig_2.png" alt="Img" /></p><p>Finally, I can just visit the vulnerable subdomain and see my proof of concept works:</p><p><em>PoC on the subdomain</em></p><p><img src="/assets/posts_details/STO-Azure/images/cloudapp_takeover.png" alt="Img" /></p><p>A good idea when reporting these kinds of vulnerabilities is to also save a snapshot of the subdomain with the <a href="https://web.archive.org/save/">Wayback Machine</a>, that way once the report gets triaged I can safely release the subdomain (Azure is expensive) without fear because I can prove the takeover was possible.</p><h1 id="azure-websites">Azure Websites</h1><hr /><p>This is another kind of service that can be taken over but in this case we need to watch out for <code class="highlighter-rouge">*.azurewebsites.net</code> domains. Let’s say I found a vulnerable subdomain, I’ll call it <code class="highlighter-rouge">takeover-subdomain.com</code> that points to <code class="highlighter-rouge">testing111111.azurewebsites.net</code> (very creative names, I know). I’ll register the domain in <a href="https://hackerone.com/redirect?url=https%3A%2F%2Fportal.azure.com%2F%23create%2FMicrosoft.WebSite">https://hackerone.com/redirect?url=https%3A%2F%2Fportal.azure.com%2F%23create%2FMicrosoft.WebSite</a>. However, this time notice I need to specify a runtime stack and a region: I chose Python and the region doesn’t matter too much.</p><p><em>Azure portal Websites Service dashboard</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_init.png" alt="Img" /></p><p><em>Registering the unclaimed domain</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_register.png" alt="Img" /></p><p><em>Registration successful</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_running.png" alt="Img" /></p><p>Cool, so now I have the service running and need to deploy the PoC.</p><h3 id="poc-creation-1">PoC creation</h3><p>When the domain is taken over I can just access <a href="https://testing111111.azurewebsites.net">https://testing111111.azurewebsites.net</a> and get the default landing page.</p><p><em>Default page</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_default.png" alt="Img" /></p><p>To create this proof of concept I just followed the documentation and copied the sample Hello World application from GitHub (check it out on <a href="https://github.com/Azure-Samples/python-docs-hello-world">https://github.com/Azure-Samples/python-docs-hello-world</a>), then I edited <code class="highlighter-rouge">app.py</code> a bit so it would return my subdomain takeover template.</p><p><em>Simple app.py PoC</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_github.png" alt="Img" /></p><p>Now to make that run on Azure I just need to go to <code class="highlighter-rouge">Deployment center</code> and select <code class="highlighter-rouge">GitHub</code> as the CI source. Then after setting up the permissions and giving Azure access the PoC will be running.</p><p><em>Using CI to upload the PoC</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_CI.png" alt="Img" /></p><p>However, the takeover wasn’t so simple and I was getting different responses from the pages: on <a href="https://testing111111.azurewebsites.net">https://testing111111.azurewebsites.net</a> I got my PoC but on <a href="https://takeover-subdomain.com">https://takeover-subdomain.com</a> I got the default Azure 404 not found page.</p><p><em>404 page on subdomain</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_404.png" alt="Img" /></p><p>After a bit of playing with it, I found that by setting the <code class="highlighter-rouge">Host</code> header when doing <code class="highlighter-rouge">curl -H 'testing111111.azurewebsites.net' https://takeover-subdomain.com</code> actually returned my PoC! That meant I needed to set up something else in the Azure dashboard. It turns out that the domain needs to be registered on the <code class="highlighter-rouge">Custom domains</code> section of the dashboard. Normally Azure asks for verification using an <code class="highlighter-rouge">A</code> or <code class="highlighter-rouge">TXT</code> record, however in this case that had already been done by the company so I just needed to add it.</p><p><em>Setting up a custom domain</em></p><p><img src="/assets/posts_details/STO-Azure/images/websites_domain.png" alt="Img" /></p><p>Doing that solved the issue and I get a PoC working flawlessly!</p><h1 id="azure-vm">Azure VM</h1><hr /><p>This is the easiest one so far, the only caveat about it is that the domains are of the form <code class="highlighter-rouge">*.region.cloudapp.azure.com</code> so I need to register a VM in that specific region for the PoC to work. Note that the name of the VM is not the name of the domain I’ll assign to it later, so I can name it as whatever I want.</p><p><em>Registering a new VM</em></p><p><img src="/assets/posts_details/STO-Azure/images/vm_init_1.png" alt="Img" /></p><p><img src="/assets/posts_details/STO-Azure/images/vm_init_2.png" alt="Img" /></p><p>Make sure the selected region is the one the subdomain has, otherwise the takeover won’t work! As for the size, I recommend using the <code class="highlighter-rouge">Standard_B1ls</code>, as it’s the cheapest one. Another important detail is to also open ports 80 and 443, as I’ll want to serve the PoC from these ports later.</p><p><em>Registration successful</em></p><p><img src="/assets/posts_details/STO-Azure/images/vm_running.png" alt="Img" /></p><p>After registering the VM, I need to go to the <code class="highlighter-rouge">Configuration</code> section and set our domain name, which is the one that’s pointed to by the subdomain I want to take over.</p><h2 id="poc-creation-2">PoC creation</h2><p>The PoC is simple, just SSH into the VM and create a simple HTML file, then serve it. I found it quicker to just run a simple Python server with <code class="highlighter-rouge">nohup</code> to detach it from the SSH session and keep it running.</p><p><em>Registration successful</em></p><p><img src="/assets/posts_details/STO-Azure/images/vm_poc.png" alt="Img" /></p><p><em>Takeover complete</em></p><p><img src="/assets/posts_details/STO-Azure/images/vm_takeover.png" alt="Img" /></p><h1 id="azure-trafficmanager">Azure Trafficmanager</h1><hr /><p>This one is also quite easy actually, we just need to register a new trafficmanager profile with the name that we found on the dangling <code class="highlighter-rouge">CNAME</code> record. This is a (redacted) example of a real world case I found:</p><p><em>Using dig to check DNS resolution</em></p><p><img src="/assets/posts_details/STO-Azure/images/trafficmanager_dig_1.png" alt="Img" /></p><p>As you can see above, the domain points to a trafficmanager <code class="highlighter-rouge">CNAME</code> that doesn’t seem to be registered. To check it, I went to the Azure portal and tried registering it.</p><p><em>Registering the trafficmanager profile</em></p><p><img src="/assets/posts_details/STO-Azure/images/trafficmanager_register.png" alt="Img" /></p><p><img src="/assets/posts_details/STO-Azure/images/trafficmanager_running.png" alt="Img" /></p><p>After it’s registered and active I went to the <code class="highlighter-rouge">Endpoints</code> section on the left-hand side menu. Here we can configure what we want to point the record to: an Azure instance or an external site. I went with the latter and pointed it to my VPS IP.</p><p><em>Creating an endpoint to my site</em></p><p><img src="/assets/posts_details/STO-Azure/images/trafficmanager_endpoint.png" alt="Img" /></p><p>To confirm that it works I checked with dig.</p><p><em>Using dig to confirm the takeover</em></p><p><img src="/assets/posts_details/STO-Azure/images/trafficmanager_dig_2.png" alt="Img" /></p><h2 id="poc-creation-3">PoC creation</h2><p>The last thing to do is to set up a web server that serves our PoC. It’s important to take into account that the requests will have the <code class="highlighter-rouge">Host</code> header of the vulnerable site. It’s because of that that many tutorials I saw online played with the Apache config to set up a new vhost. I didn’t want to install Apache and opted to go for a simpler approach using a NodeJS snippet.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">});</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">PoC by GoDiego (&lt;a href=https://hackerone.com/diegobernal&gt;https://hackerone.com/diegobernal&lt;/a&gt;)</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
</pre></table></code></div></div><p>Then I just ran it with <code class="highlighter-rouge">nohup nodejs poc.js &amp;</code> and had a working PoC.</p><p><em>Working PoC</em></p><p><img src="/assets/posts_details/STO-Azure/images/trafficmanager_takeover.png" alt="Img" /></p><h1 id="takeaways">Takeaways</h1><hr /><p>This is everything! I hope you learned something useful, I tried to include all the little details that made me spend a lot of time trying to figure out how things worked. Hopefully, this article will grow with time and I’ll add new PoCs so stay tuned!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/bug-bounty/'>Bug Bounty</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/bug-bounty/" class="post-tag no-text-decoration" >Bug Bounty</a> <a href="/tags/subdomain-takeover/" class="post-tag no-text-decoration" >Subdomain takeover</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Subdomain Takeover in Azure: making a PoC - GoDiego&url=https://diego95root.github.io/posts/STO-Azure/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Subdomain Takeover in Azure: making a PoC - GoDiego&u=https://diego95root.github.io/posts/STO-Azure/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Subdomain Takeover in Azure: making a PoC - GoDiego&url=https://diego95root.github.io/posts/STO-Azure/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://diego95root.github.io/posts/STO-Azure/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Fuse/">HackTheBox: Fuse write-up</a></li><li><a href="/posts/Magic/">Hack The Box: Magic write-up</a></li><li><a href="/posts/Cache/">HackTheBox: Cache write-up</a></li><li><a href="/posts/Blunder/">HackTheBox: Blunder write-up</a></li><li><a href="/posts/Admirer/">HackTheBox: Admirer write-up</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/enumeration/">Enumeration</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Passage/" class="btn btn-outline-primary"><p>HackTheBox: Passage write-up</p></a> <a href="/posts/Bucket/" class="btn btn-outline-primary"><p>HackTheBox: Bucket write-up</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/STO-AWS/"><div class="card-body"> <span class="timeago small"> Mar 20, 2021 <i class="unloaded">2021-03-20T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Subdomain Takeover in AWS: making a PoC</h3><div class="text-muted small"><p> Note: this is not the classic ‘What is a subdomain takeover?’ post, I’m assuming everyone who reads this already has some knowledge of this kind of issues and don’t explain what a subdomain take...</p></div></div></a></div><div class="card"> <a href="/posts/H1-2006-CTF/"><div class="card-body"> <span class="timeago small"> Jun 9, 2020 <i class="unloaded">2020-06-09T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackerOne h1-2006 CTF write-up</h3><div class="text-muted small"><p>HackerOne h1-2006 CTF write-up: How I solved it Hello everyone, in this post I will go over how I managed to solve the HackerOne h12006 CTF. It was the best CTF challenge I’ve ever played, not onl...</p></div></div></a></div><div class="card"> <a href="/posts/Intrigriti-XSS-Easter/"><div class="card-body"> <span class="timeago small"> Apr 20, 2020 <i class="unloaded">2020-04-20T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Intigriti Easter XSS challenge solution</h3><div class="text-muted small"><p>Intigriti Easter XSS challenge solution This blog post will go over how I managed to solve the Intigriti Easter challenge, which took definitely way too long. Even though I spent more than 2 days ...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js" crossorigin="anonymous"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/secfaults">Diego Bernal Adelantado</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/permissions/">Permissions</a> <a class="post-tag" href="/tags/ssh/">SSH</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/enumeration/">Enumeration</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/john/">John</a> <a class="post-tag" href="/tags/file-upload/">File Upload</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-167902069-1', 'auto'); ga('send', 'pageview'); </script> --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-167902069-1" crossorigin="anonymous"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-167902069-1'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://diego95root.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
